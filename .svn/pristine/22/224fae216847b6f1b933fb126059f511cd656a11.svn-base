from osgeo import gdal
import numpy as np
import ogr
import osr


def write_raster(file_path, rast_array, no_data_value, rast_cols, rast_rows, projection, transform):
    driver = gdal.GetDriverByName('Gtiff')
    raster = driver.Create(file_path, rast_cols, rast_rows, 1, gdal.GDT_Float32)
    band = raster.GetRasterBand(1)
    band.SetNoDataValue(no_data_value)
    band.WriteArray(rast_array)
    raster.SetProjection(projection)
    raster.SetGeoTransform(transform)
    band.FlushCache()


def apply_usa_mask(rast_array):
    mask = gdal.Open('util/mask_4269.tif')
    mask_band = mask.GetRasterBand(1)
    mask_array = mask_band.ReadAsArray()
    rast_array[rast_array == 0] = .0001
    rast_array *= mask_array
    rast_array[rast_array == 0] = -9999


def get_point_as_long_lat(coord_x, coord_y, input_epsg):
    # Spatial Reference System
    output_epsg = 4326

    # create a geometry from coordinates
    point = ogr.Geometry(ogr.wkbPoint)
    point.AddPoint(coord_x, coord_y)

    # create coordinate transformation
    in_spatial_ref = osr.SpatialReference()
    in_spatial_ref.ImportFromEPSG(input_epsg)

    out_spatial_ref = osr.SpatialReference()
    out_spatial_ref.ImportFromEPSG(output_epsg)

    coord_transform = osr.CoordinateTransformation(in_spatial_ref, out_spatial_ref)

    # transform point
    point.Transform(coord_transform)

    # print point in EPSG 4326
    return point.GetX(), point.GetY()
